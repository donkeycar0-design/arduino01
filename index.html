<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì—°êµ¬ì‹¤ ê³µê¸°ì§ˆ ëª¨ë‹ˆí„°ë§</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
    body {
      font-family: 'Pretendard', sans-serif;
    }
    .status-dot {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4 md:p-8">

  <div class="max-w-6xl w-full grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- ì™¼ìª½: í˜„ì¬ ìˆ˜ì¹˜ ì¹´ë“œ -->
    <div class="lg:col-span-1 bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 flex flex-col">
      <div class="bg-indigo-700 p-6 text-white">
        <div class="flex justify-between items-center mb-2">
          <span class="text-indigo-100 text-sm font-medium uppercase tracking-wider">Lab Environment</span>
          <div class="flex items-center gap-2">
            <span id="status-text" class="text-xs">ì—°ê²°ë¨</span>
            <div id="status-dot" class="w-2 h-2 bg-green-400 rounded-full status-dot"></div>
          </div>
        </div>
        <h1 class="text-2xl font-bold">ì—°êµ¬ì‹¤ ê³µê¸°ì§ˆ í˜„í™©</h1>
      </div>

      <div class="p-8 space-y-8 flex-grow">
        <!-- Temperature -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center text-2xl">ğŸŒ¡ï¸</div>
            <div>
              <p class="text-slate-500 text-sm font-medium">í˜„ì¬ ì˜¨ë„</p>
              <h2 id="temp" class="text-3xl font-bold text-slate-800">-- Â°C</h2>
            </div>
          </div>
        </div>

        <!-- Humidity -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-2xl">ğŸ’§</div>
            <div>
              <p class="text-slate-500 text-sm font-medium">í˜„ì¬ ìŠµë„</p>
              <h2 id="humi" class="text-3xl font-bold text-slate-800">-- %</h2>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-100 pt-6">
          <div class="flex flex-col items-center text-center">
            <p class="text-slate-400 text-xs mb-1">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</p>
            <p id="time" class="text-slate-600 text-sm font-medium">ë°ì´í„° ë¡œë”© ì¤‘...</p>
          </div>
        </div>

        <button onclick="fetchData()" class="w-full py-3 px-4 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-xl transition-colors duration-200 flex items-center justify-center gap-2 text-sm mt-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M240,128a112,112,0,0,1-212.71,39.05,8,8,0,0,1,13.42-8.77A96,96,0,1,0,56.8,71.16L33.37,94.59A8,8,0,0,1,20,88.94V24a8,8,0,0,1,16,0V63.51L59.51,40A112,112,0,0,1,240,128Z"></path></svg>
          ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
        </button>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ê·¸ë˜í”„ ì„¹ì…˜ -->
    <div class="lg:col-span-2 bg-white rounded-3xl shadow-xl p-6 border border-slate-100 flex flex-col min-h-[400px]">
      <div class="mb-4 flex justify-between items-end">
        <div>
          <h3 class="text-lg font-bold text-slate-800">ì‹œê°„ë³„ ë³€í™” ì¶”ì´</h3>
          <p class="text-sm text-slate-500">ìµœê·¼ 20ê°œì˜ ìˆ˜ì§‘ ë°ì´í„°ê°€ ê·¸ë˜í”„ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
      </div>
      <div class="flex-grow relative">
        <canvas id="sensorChart"></canvas>
      </div>
    </div>

  </div>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbwc9T3Ij7wtdQL6dgaUkdamGtzsvkYplm26wip9pj93ARX2BNaBgNtpaushccxDBZLh/exec";
    let myChart;
    const MAX_DATA_POINTS = 20;

    function initChart() {
      const ctx = document.getElementById('sensorChart').getContext('2d');
      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'ì˜¨ë„ (Â°C)',
              data: [],
              borderColor: '#f97316',
              backgroundColor: 'rgba(249, 115, 22, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              yAxisID: 'y'
            },
            {
              label: 'ìŠµë„ (%)',
              data: [],
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { grid: { display: false } },
            y: { 
              type: 'linear', display: true, position: 'left',
              title: { display: true, text: 'ì˜¨ë„ (Â°C)', font: { weight: 'bold' } },
              suggestedMin: 15, suggestedMax: 35
            },
            y1: {
              type: 'linear', display: true, position: 'right',
              title: { display: true, text: 'ìŠµë„ (%)', font: { weight: 'bold' } },
              suggestedMin: 20, suggestedMax: 80,
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    function updateStatus(isError) {
      const dot = document.getElementById("status-dot");
      const text = document.getElementById("status-text");
      if (isError) {
        dot.classList.replace("bg-green-400", "bg-red-500");
        text.innerText = "ì—°ê²° ì˜¤ë¥˜";
      } else {
        dot.classList.replace("bg-red-500", "bg-green-400");
        text.innerText = "ì—°ê²°ë¨";
      }
    }

    async function fetchData() {
      const timeEl = document.getElementById("time");
      const tempEl = document.getElementById("temp");
      const humiEl = document.getElementById("humi");

      try {
        const response = await fetch(webAppUrl);
        if (!response.ok) throw new Error('Network error');
        const data = await response.json();
        
        tempEl.innerText = data.temp + " Â°C";
        humiEl.innerText = data.humi + " %";
        const date = new Date(data.time);
        const timeLabel = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        timeEl.innerText = date.toLocaleString('ko-KR');

        if (myChart) {
          const lastLabel = myChart.data.labels[myChart.data.labels.length - 1];
          if (lastLabel !== timeLabel) {
            myChart.data.labels.push(timeLabel);
            myChart.data.datasets[0].data.push(data.temp);
            myChart.data.datasets[1].data.push(data.humi);

            if (myChart.data.labels.length > MAX_DATA_POINTS) {
              myChart.data.labels.shift();
              myChart.data.datasets[0].data.shift();
              myChart.data.datasets[1].data.shift();
            }
            myChart.update('none');
          }
        }
        updateStatus(false);
      } catch (error) {
        console.error("ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨:", error);
        updateStatus(true);
      }
    }

    window.onload = function() {
      initChart();
      fetchData();
      setInterval(fetchData, 60000);
    };
  </script>
</body>
</html>
